<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gilead Couriers — Book a Job</title>

    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        color:#111;
        background:
          linear-gradient(180deg, rgba(11,31,59,0.92), rgba(11,31,59,0.65)),
          url("/app/images/hero-courier.jpg");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
      }

      .wrap { max-width: 760px; margin: 0 auto; }

      .card {
        background: rgba(255,255,255,0.94);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid rgba(255,255,255,0.6);
        box-shadow: 0 14px 34px rgba(0,0,0,0.18);
        backdrop-filter: blur(3px);
      }

      h1 { margin: 0 0 8px; font-size: 24px; }
      p.sub { margin: 0 0 20px; color:#444; }

      label { display:block; font-weight:600; margin: 14px 0 6px; }

      input, textarea, select {
        width:100%;
        box-sizing:border-box;
        padding: 10px 12px;
        border: 1px solid #d7dbe7;
        border-radius: 10px;
        font-size: 14px;
        background: #fff;
      }

      textarea { min-height: 76px; resize: vertical; }

      .row { display:flex; gap: 12px; }
      .row > div { flex:1; }

      .hint { font-size: 12px; color:#666; margin-top: 6px; }

      .btn {
        margin-top: 18px;
        width:100%;
        padding: 12px 14px;
        border:0;
        border-radius: 12px;
        font-weight:700;
        cursor:pointer;
        background:#111;
        color:#fff;
        font-size: 15px;
      }

      .btn:disabled { opacity: 0.65; cursor: not-allowed; }

      .footer { margin-top: 14px; font-size: 12px; color:#555; }

      .footer a {
        text-decoration: underline;
        text-underline-offset: 2px;
        color: inherit;
      }

      .footer a:hover { color:#0B1F3B; }

      .status { margin-top: 10px; font-size: 13px; color: #111; }
      .status.error { color: #b00020; }

      .estimate {
        margin-top: 14px;
        padding: 12px;
        border-radius: 12px;
        background: rgba(11,31,59,0.06);
        border: 1px solid rgba(11,31,59,0.12);
        display: none;
      }
      .estimate .label { font-size: 12px; color:#555; margin-bottom: 6px; }
      .estimate .value { font-size: 18px; font-weight: 900; letter-spacing: 0.2px; }
      .estimate .warn { margin-top: 8px; font-size: 12px; color:#7a1c00; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <h1>Book a courier job</h1>
        <p class="sub">
          Premium fixed fee within 20 miles. Long-distance is priced by mileage + premium rules.
          Secure payment via Stripe.
        </p>

        <form id="bookingForm">

          <!-- COMPANY + INDUSTRY -->
          <div class="row">
            <div>
              <label for="company">Company / Business name *</label>
              <input
                id="company"
                name="company"
                type="text"
                required
                placeholder="e.g. Rolls Royce plc"
              />
            </div>

            <div>
              <label for="industry">Industry *</label>
              <select id="industry" name="industry" required>
                <option value="">Select industry</option>
                <option value="Aerospace">Aerospace</option>
                <option value="Defence">Defence</option>
                <option value="Engineering">Engineering</option>
                <option value="Legal">Legal</option>
                <option value="Medical">Medical</option>
                <option value="Financial Services">Financial Services</option>
                <option value="Government / Public Sector">Government / Public Sector</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <!-- SERVICE TYPE -->
          <label for="serviceType">Service type *</label>
          <select id="serviceType" name="serviceType" required>
            <option value="oneway">One-way (Pickup → Drop-off)</option>
            <option value="return_same_day">Return same day (Deliver + collect + return to pickup)</option>
          </select>
          <div class="hint">
            Return same day prices as a dedicated shuttle (miles are calculated for one-way, then priced as a round trip).
          </div>

          <!-- PICKUP -->
          <label for="pickup">Pickup address *</label>
          <textarea
            id="pickup"
            name="pickup"
            required
            placeholder="e.g. 10 Downing Street, London SW1A 2AA"
          ></textarea>

          <!-- DROPOFF -->
          <label for="dropoff">Drop-off address *</label>
          <textarea
            id="dropoff"
            name="dropoff"
            required
            placeholder="e.g. 1 St Peter’s Square, Manchester M2 3AE"
          ></textarea>

          <div class="row">
            <div>
              <button type="button" class="btn" id="calcMilesBtn">
                Miles calculated automatically *
              </button>

              <input
                id="miles"
                name="miles"
                type="number"
                min="1"
                step="1"
                required
                placeholder="e.g. 234"
                readonly
                style="margin-top:10px;"
              />

              <div class="hint" id="milesHint">
                We’ll calculate miles from the pickup &amp; drop-off postcodes (one-way).
              </div>
            </div>

            <div>
              <label for="email">Your email address *</label>
              <input
                id="email"
                name="email"
                type="email"
                required
                placeholder="you@example.com"
              />
            </div>
          </div>

          <label for="poNumber">Purchase Order Number (optional)</label>
          <input
            id="poNumber"
            name="poNumber"
            type="text"
            placeholder="e.g. PO-123456"
          />

          <div class="row">
            <div>
              <label for="whenDate">When is this job needed? (date) *</label>
              <input id="whenDate" name="whenDate" type="date" required />
            </div>

            <div>
              <label for="whenTime">Time needed by *</label>
              <input id="whenTime" name="whenTime" type="time" required />
            </div>
          </div>

          <label for="notes">Notes (optional)</label>
          <textarea
            id="notes"
            name="notes"
            placeholder="Fragile items, access instructions, parking, contact name, etc."
          ></textarea>

          <!-- Total-only estimate -->
          <div id="estimateBox" class="estimate">
            <div class="label">Estimated premium price</div>
            <div id="estimateValue" class="value">—</div>
            <div id="estimateWarn" class="warn" style="display:none;"></div>
          </div>

          <button class="btn" id="submitBtn" type="submit">Book &amp; Pay</button>

          <div id="status" class="status" aria-live="polite"></div>

          <div class="footer">
            By proceeding you agree to our
            <a href="/terms.html">Terms</a>,
            <a href="/refund-policy.html">Refund Policy</a> and
            <a href="/privacy-policy.html">Privacy Policy</a>.
          </div>
        </form>
      </div>
    </div>

    <script>
      (function () {
        const CHECKOUT_ENDPOINT = "/api/stripe/create-checkout-session-v2";

        const form = document.getElementById("bookingForm");
        const statusEl = document.getElementById("status");
        const submitBtn = document.getElementById("submitBtn");

        const estimateBox = document.getElementById("estimateBox");
        const estimateValue = document.getElementById("estimateValue");
        const estimateWarn = document.getElementById("estimateWarn");

        // ---------------------------
        // BASE PRICING (DEFAULT / OTHER) — PREMIUM RETAIL LOGIC
        // ---------------------------
        const PRICING = {
          baseUpTo20: 120,
          perMileOver20: 3.5,
          uplift: [
            { min: 80, max: 119, add: 50 },
            { min: 120, max: 179, add: 90 }
          ],
          manualQuoteMiles: 180,

          urgencyMinutes: 180,
          urgencyAdd: 40,
          after17Add: 35,
          weekendAdd: 60,
          bankHolidayAdd: 90,

          rounding: 5
        };

        // ---------------------------
        // INDUSTRY PRICING PROFILES (CONSISTENT RETURN-SAME-DAY BEHAVIOUR)
        // ---------------------------
        const INDUSTRY_PRICING = {
          "Aerospace": {
            oneway: {
              baseUpTo20: 120,
              perMileOver20: 2.5,
              uplift: [
                { min: 80,  max: 119, add: 35 },
                { min: 120, max: 179, add: 60 },
                { min: 180, max: 259, add: 105 }
              ],
              manualQuoteMiles: 260,
              urgencyMinutes: 180,
              urgencyAdd: 25,
              after17Add: 25,
              weekendAdd: 50,
              bankHolidayAdd: 80,
              rounding: 10
            },
            return_same_day: {
              baseUpTo20: 120,

              // Recalibrated, non-linear:
              // Effective miles = 2× one-way miles.
              // 156 one-way => 312 effective => £500 (rounded to £10)
              // 190 one-way => 380 effective => £650 (rounded to £10)
              perMileOver20: 1.30,

              // Distance uplift only for longer return shuttles (effective miles ≥ 340)
              uplift: [
                { min: 340, max: 520, add: 60 }
              ],

              manualQuoteMiles: 520, // effective miles
              urgencyMinutes: 180,
              urgencyAdd: 25,
              after17Add: 25,
              weekendAdd: 50,
              bankHolidayAdd: 80,
              rounding: 10
            }
          },

          "Defence": {
            oneway: {
              baseUpTo20: 120,
              perMileOver20: 2.35,
              uplift: [
                { min: 80, max: 119, add: 40 },
                { min: 120, max: 179, add: 70 }
              ],
              manualQuoteMiles: 240,
              urgencyMinutes: 180,
              urgencyAdd: 30,
              after17Add: 30,
              weekendAdd: 55,
              bankHolidayAdd: 85,
              rounding: 10
            },
            return_same_day: {
              baseUpTo20: 120,
              perMileOver20: 1.85,
              uplift: [
                { min: 260, max: 520, add: 40 }
              ],
              manualQuoteMiles: 480,
              urgencyMinutes: 180,
              urgencyAdd: 30,
              after17Add: 30,
              weekendAdd: 55,
              bankHolidayAdd: 85,
              rounding: 10
            }
          },

          "Engineering": {
            oneway: {
              baseUpTo20: 120,
              perMileOver20: 2.5,
              uplift: [
                { min: 80, max: 119, add: 45 },
                { min: 120, max: 179, add: 80 }
              ],
              manualQuoteMiles: 220,
              urgencyMinutes: 180,
              urgencyAdd: 30,
              after17Add: 30,
              weekendAdd: 55,
              bankHolidayAdd: 85,
              rounding: 10
            },
            return_same_day: {
              baseUpTo20: 120,
              perMileOver20: 1.95,
              uplift: [
                { min: 240, max: 480, add: 35 }
              ],
              manualQuoteMiles: 440,
              urgencyMinutes: 180,
              urgencyAdd: 30,
              after17Add: 30,
              weekendAdd: 55,
              bankHolidayAdd: 85,
              rounding: 10
            }
          },

          "Government / Public Sector": {
            oneway: {
              baseUpTo20: 120,
              perMileOver20: 2.4,
              uplift: [
                { min: 80, max: 119, add: 40 },
                { min: 120, max: 179, add: 70 }
              ],
              manualQuoteMiles: 220,
              urgencyMinutes: 180,
              urgencyAdd: 25,
              after17Add: 25,
              weekendAdd: 50,
              bankHolidayAdd: 80,
              rounding: 10
            },
            return_same_day: {
              baseUpTo20: 120,
              perMileOver20: 1.85,
              uplift: [
                { min: 240, max: 480, add: 25 }
              ],
              manualQuoteMiles: 440,
              urgencyMinutes: 180,
              urgencyAdd: 25,
              after17Add: 25,
              weekendAdd: 50,
              bankHolidayAdd: 80,
              rounding: 10
            }
          },

          "Legal": {
            oneway: {
              baseUpTo20: 120,
              perMileOver20: 3.5,
              uplift: [
                { min: 80, max: 119, add: 50 },
                { min: 120, max: 179, add: 90 }
              ],
              manualQuoteMiles: 180,
              urgencyMinutes: 180,
              urgencyAdd: 45,
              after17Add: 40,
              weekendAdd: 70,
              bankHolidayAdd: 95,
              rounding: 5
            },
            return_same_day: {
              baseUpTo20: 120,
              perMileOver20: 2.85,
              uplift: [
                { min: 240, max: 480, add: 80 }
              ],
              manualQuoteMiles: 360,
              urgencyMinutes: 180,
              urgencyAdd: 55,
              after17Add: 45,
              weekendAdd: 80,
              bankHolidayAdd: 110,
              rounding: 5
            }
          },

          "Medical": {
            oneway: {
              baseUpTo20: 120,
              perMileOver20: 3.1,
              uplift: [
                { min: 80, max: 119, add: 45 },
                { min: 120, max: 179, add: 85 }
              ],
              manualQuoteMiles: 200,
              urgencyMinutes: 180,
              urgencyAdd: 40,
              after17Add: 35,
              weekendAdd: 70,
              bankHolidayAdd: 100,
              rounding: 5
            },
            return_same_day: {
              baseUpTo20: 120,
              perMileOver20: 2.65,
              uplift: [
                { min: 240, max: 520, add: 70 }
              ],
              manualQuoteMiles: 400,
              urgencyMinutes: 180,
              urgencyAdd: 50,
              after17Add: 40,
              weekendAdd: 80,
              bankHolidayAdd: 120,
              rounding: 5
            }
          },

          "Financial Services": {
            oneway: {
              baseUpTo20: 120,
              perMileOver20: 3.25,
              uplift: [
                { min: 80, max: 119, add: 50 },
                { min: 120, max: 179, add: 90 }
              ],
              manualQuoteMiles: 200,
              urgencyMinutes: 180,
              urgencyAdd: 40,
              after17Add: 40,
              weekendAdd: 65,
              bankHolidayAdd: 95,
              rounding: 5
            },
            return_same_day: {
              baseUpTo20: 120,
              perMileOver20: 2.70,
              uplift: [
                { min: 240, max: 520, add: 75 }
              ],
              manualQuoteMiles: 400,
              urgencyMinutes: 180,
              urgencyAdd: 50,
              after17Add: 45,
              weekendAdd: 75,
              bankHolidayAdd: 110,
              rounding: 5
            }
          },

          "Other": {
            oneway: null,
            return_same_day: {
              baseUpTo20: 120,
              perMileOver20: 2.35,
              uplift: [
                { min: 240, max: 480, add: 50 }
              ],
              manualQuoteMiles: 360,
              urgencyMinutes: 180,
              urgencyAdd: 40,
              after17Add: 35,
              weekendAdd: 65,
              bankHolidayAdd: 95,
              rounding: 5
            }
          }
        };

        function setStatus(msg, type) {
          statusEl.textContent = msg || "";
          statusEl.className = "status" + (type ? (" " + type) : "");
        }

        function getVal(id) {
          const el = document.getElementById(id);
          return el ? el.value : "";
        }

        function parseMiles(v) {
          const n = Number(String(v || "").trim());
          if (!Number.isFinite(n)) return 0;
          return Math.max(0, Math.round(n));
        }

        function roundToNearest(amount, nearest) {
          const n = Number(nearest) || 1;
          return Math.round(amount / n) * n;
        }

        function isWeekend(dateObj) {
          const d = dateObj.getDay();
          return d === 0 || d === 6;
        }

        function isBankHolidayPlaceholder() {
          return false;
        }

        function getPricingProfile(industry, serviceType) {
          const key = String(industry || "").trim();
          const st = String(serviceType || "oneway").trim();

          const industryPack = INDUSTRY_PRICING[key];
          const override = industryPack && industryPack[st] ? industryPack[st] : null;

          const merged = override ? { ...PRICING, ...override } : { ...PRICING };
          if (override && override.uplift) merged.uplift = override.uplift;
          return merged;
        }

        function extractPostcode(text) {
          const t = String(text || "").toUpperCase();
          const m = t.match(/\b([A-Z]{1,2}\d{1,2}[A-Z]?)\s*?(\d[A-Z]{2})\b/);
          return m ? (m[1] + " " + m[2]).replace(/\s+/g, " ").trim() : "";
        }

        async function calculateMilesFromPostcodes() {
          const pickupText = getVal("pickup");
          const dropoffText = getVal("dropoff");

          const from = extractPostcode(pickupText);
          const to = extractPostcode(dropoffText);

          const milesEl = document.getElementById("miles");

          if (!from || !to) {
            setStatus("Enter valid UK postcodes in Pickup and Drop-off, then click 'Calculate miles automatically'.", "error");
            if (milesEl) milesEl.readOnly = false;
            return;
          }

          setStatus("Calculating miles…", "");
          submitBtn.disabled = true;

          try {
            const resp = await fetch(`/api/calc-miles?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
            const data = await resp.json().catch(() => ({}));

            if (!resp.ok || !data || !data.miles) {
              throw new Error(data.error || "Miles calculation failed");
            }

            if (milesEl) {
              milesEl.value = String(data.miles);
              milesEl.readOnly = true;
            }

            setStatus(`Miles calculated: ${data.miles} miles`, "");
            renderEstimate();
          } catch (e) {
            setStatus("Could not calculate miles automatically. Please enter miles manually.", "error");
            if (milesEl) milesEl.readOnly = false;
          } finally {
            submitBtn.disabled = false;
          }
        }

        const calcBtn = document.getElementById("calcMilesBtn");
        if (calcBtn) calcBtn.addEventListener("click", calculateMilesFromPostcodes);

        ["pickup", "dropoff"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("blur", () => {
            const milesEl = document.getElementById("miles");
            if (milesEl && !String(milesEl.value || "").trim()) {
              calculateMilesFromPostcodes();
            }
          });
        });

        function computeTotal(oneWayMiles, whenDateStr, whenTimeStr, industry, serviceType) {
          const P = getPricingProfile(industry, serviceType);

          if (!oneWayMiles || oneWayMiles < 1) {
            return { ok: false, manual: false, total: 0, reason: "Enter estimated miles to see an estimate." };
          }

          const isReturn = String(serviceType) === "return_same_day";
          const effectiveMiles = isReturn ? (oneWayMiles * 2) : oneWayMiles;

          if (effectiveMiles >= P.manualQuoteMiles) {
            return {
              ok: false,
              manual: true,
              total: 0,
              reason: `For ${P.manualQuoteMiles}+ miles, Gilead issues a manual premium quote.`
            };
          }

          const over20 = Math.max(0, effectiveMiles - 20);
          let total = P.baseUpTo20 + (over20 * P.perMileOver20);

          for (const b of (P.uplift || [])) {
            if (effectiveMiles >= b.min && effectiveMiles <= b.max) {
              total += b.add;
              break;
            }
          }

          let whenDt = null;
          if (whenDateStr && whenTimeStr) {
            const iso = `${whenDateStr}T${whenTimeStr}:00`;
            const dt = new Date(iso);
            if (!Number.isNaN(dt.getTime())) whenDt = dt;
          }

          let urgent = false;
          let after17 = false;
          let weekend = false;
          let bankHoliday = false;

          if (whenDt) {
            after17 = whenDt.getHours() >= 17;
            weekend = isWeekend(whenDt);
            bankHoliday = isBankHolidayPlaceholder();
            const now = new Date();
            const diffMinutes = (whenDt.getTime() - now.getTime()) / 60000;
            urgent = diffMinutes >= 0 && diffMinutes < P.urgencyMinutes;
          }

          if (urgent) total += P.urgencyAdd;
          if (after17) total += P.after17Add;

          if (bankHoliday) total += P.bankHolidayAdd;
          else if (weekend) total += P.weekendAdd;

          total = roundToNearest(total, P.rounding);

          const note = isReturn ? "Return same day pricing applied (round trip)." : "";
          return { ok: true, manual: false, total, reason: "", metaNote: note };
        }

        function fmtGBP(n) {
          const v = Number(n || 0);
          return new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP" }).format(v);
        }

        function renderEstimate() {
          const oneWayMiles = parseMiles(getVal("miles"));
          const whenDate = getVal("whenDate");
          const whenTime = getVal("whenTime");
          const industry = getVal("industry");
          const serviceType = getVal("serviceType");

          if (!oneWayMiles) {
            estimateBox.style.display = "none";
            estimateValue.textContent = "—";
            estimateWarn.style.display = "none";
            estimateWarn.textContent = "";
            return;
          }

          const r = computeTotal(oneWayMiles, whenDate, whenTime, industry, serviceType);

          estimateBox.style.display = "block";

          if (!r.ok) {
            estimateValue.textContent = r.manual ? "Manual quote" : "—";
            estimateWarn.style.display = "block";
            estimateWarn.textContent = r.reason || "Unable to estimate.";
            return;
          }

          estimateValue.textContent = fmtGBP(r.total);

          if (r.metaNote) {
            estimateWarn.style.display = "block";
            estimateWarn.textContent = r.metaNote;
          } else {
            estimateWarn.style.display = "none";
            estimateWarn.textContent = "";
          }
        }

        ["industry", "serviceType", "miles", "whenDate", "whenTime"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("input", renderEstimate);
          if (el) el.addEventListener("change", renderEstimate);
        });

        renderEstimate();

        try {
          const params = new URLSearchParams(window.location.search || "");
          const qsStatus = params.get("status");
          if (qsStatus === "success") {
            const ref = localStorage.getItem("gc_bookingRef");
            if (ref) {
              setStatus("Payment received — Booking reference: " + ref, "");
              localStorage.removeItem("gc_bookingRef");
            }
          }
        } catch (e) { /* ignore */ }

        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          setStatus("Creating secure payment…", "");
          submitBtn.disabled = true;

          const payload = {
            company: getVal("company").trim(),
            industry: getVal("industry"),
            serviceType: getVal("serviceType"),
            pickup: getVal("pickup").trim(),
            dropoff: getVal("dropoff").trim(),
            miles: getVal("miles"),
            email: getVal("email").trim(),
            poNumber: getVal("poNumber").trim(),
            whenDate: getVal("whenDate"),
            whenTime: getVal("whenTime"),
            notes: getVal("notes").trim()
          };

          if (!payload.company || !payload.industry || !payload.serviceType || !payload.pickup || !payload.dropoff ||
              !payload.miles || !payload.email || !payload.whenDate || !payload.whenTime) {
            setStatus("Please complete all required fields.", "error");
            submitBtn.disabled = false;
            return;
          }

          const oneWayMiles = parseMiles(payload.miles);
          const P = getPricingProfile(payload.industry, payload.serviceType);
          const effectiveMiles = (payload.serviceType === "return_same_day") ? (oneWayMiles * 2) : oneWayMiles;

          if (effectiveMiles >= P.manualQuoteMiles) {
            setStatus(`For ${P.manualQuoteMiles}+ miles, Gilead issues a manual premium quote. Please contact dispatch for a bespoke price.`, "error");
            submitBtn.disabled = false;
            return;
          }

          try {
            const resp = await fetch(CHECKOUT_ENDPOINT, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const data = await resp.json().catch(() => ({}));

            if (!resp.ok || !data.url) {
              setStatus("Unable to create checkout session. Please try again.", "error");
              submitBtn.disabled = false;
              return;
            }

            try {
              if (data.bookingRef) {
                localStorage.setItem("gc_bookingRef", String(data.bookingRef));
              }
            } catch (e) { /* ignore */ }

            window.location.href = data.url;
          } catch (err) {
            setStatus("Network error. Please try again.", "error");
            submitBtn.disabled = false;
          }
        });
      })();
    </script>
  </body>
</html>
