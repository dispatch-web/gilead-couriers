<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gilead Couriers — Book a Job</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        background:
          linear-gradient(rgba(245,247,251,0.94), rgba(245,247,251,0.94)),
          url("/app/images/hero-courier.jpg");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        color:#111;
      }

      .wrap {
        max-width: 760px;
        margin: 0 auto;
        background: #EEF2F8;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
      }

      h1 { margin: 0 0 8px; font-size: 24px; }
      p.sub { margin: 0 0 20px; color:#444; }

      label { display:block; font-weight:600; margin: 14px 0 6px; }

      input, textarea {
        width:100%;
        box-sizing:border-box;
        padding: 10px 12px;
        border: 1px solid #d7dbe7;
        border-radius: 10px;
        font-size: 14px;
        background:#fff;
      }

      textarea { min-height: 76px; resize: vertical; }

      .row { display:flex; gap: 12px; }
      .row > div { flex:1; }

      .hint { font-size: 12px; color:#666; margin-top: 6px; }

      .btn {
        margin-top: 18px;
        width:100%;
        padding: 12px 14px;
        border:0;
        border-radius: 12px;
        font-weight:700;
        cursor:pointer;
        background:#111;
        color:#fff;
        font-size: 15px;
      }

      .btn[disabled]{ opacity:.6; cursor:not-allowed; }

      .msg { margin-top: 14px; padding: 12px; border-radius: 10px; display:none; }
      .msg.ok { background:#e9f8ef; color:#0f5132; border:1px solid #b7ebc6; }
      .msg.err { background:#fdecec; color:#842029; border:1px solid #f5c2c7; }

      .footer {
        margin-top: 14px;
        font-size: 12px;
        color:#666;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Book a courier job</h1>
      <p class="sub">Fixed fee within 20 miles. Long-distance is priced by mileage + rules. Secure payment via Stripe.</p>

      <form id="bookingForm">
        <label for="pickup">Pickup address *</label>
        <textarea id="pickup" name="pickup" required placeholder="e.g. 10 Downing Street, London SW1A 2AA"></textarea>

        <label for="dropoff">Drop-off address *</label>
        <textarea id="dropoff" name="dropoff" required placeholder="e.g. 1 St Peter’s Square, Manchester M2 3AE"></textarea>

        <div class="row">
          <div>
            <label for="miles">Estimated miles *</label>
            <input id="miles" name="miles" type="number" min="1" step="1" required placeholder="e.g. 234" />
            <div class="hint">Enter an approximate mileage for now (routing automation comes later).</div>
          </div>
          <div>
            <label for="email">Your email address *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="whenDate">When is this job needed? (date) *</label>
            <input id="whenDate" name="whenDate" type="date" required />
          </div>
          <div>
            <label for="whenTime">Time needed by *</label>
            <input id="whenTime" name="whenTime" type="time" required />
          </div>
        </div>

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" name="notes" placeholder="Fragile items, access instructions, parking, contact name, etc."></textarea>

        <button class="btn" id="payBtn" type="submit">Book &amp; Pay</button>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>

        <div class="footer">
          By proceeding you agree to our terms and policies.
        </div>
      </form>
    </div>

    <script>
      (function () {
        const form = document.getElementById('bookingForm');
        const payBtn = document.getElementById('payBtn');
        const msgOk = document.getElementById('msgOk');
        const msgErr = document.getElementById('msgErr');

        function showOk(text) {
          msgOk.textContent = text;
          msgOk.style.display = 'block';
          msgErr.style.display = 'none';
        }

        function showErr(text) {
          msgErr.textContent = text;
          msgErr.style.display = 'block';
          msgOk.style.display = 'none';
        }

        function setBusy(isBusy, label) {
          payBtn.disabled = isBusy;
          payBtn.textContent = label || (isBusy ? 'Working…' : 'Book & Pay');
        }

        function v(id) {
          const el = document.getElementById(id);
          return (el && typeof el.value === 'string') ? el.value.trim() : '';
        }

        async function safeJson(resp) {
          const text = await resp.text();
          try { return { ok: resp.ok, status: resp.status, json: JSON.parse(text) }; }
          catch { return { ok: false, status: resp.status, json: null, raw: text }; }
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          msgOk.style.display = 'none';
          msgErr.style.display = 'none';

          const pickup = v('pickup');
          const dropoff = v('dropoff');
          const miles = v('miles');
          const email = v('email');
          const whenDate = v('whenDate');
          const whenTime = v('whenTime');
          const notes = v('notes');

          if (!pickup || !dropoff || !miles || !email || !whenDate || !whenTime) {
            showErr('Missing required fields to check availability.');
            return;
          }

          const milesNum = Number(miles);
          if (!Number.isFinite(milesNum) || milesNum <= 0) {
            showErr('Please enter a valid mileage value.');
            return;
          }

          try {
            setBusy(true, 'Checking availability…');

            const availResp = await fetch('/api/availability', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                pickup,
                dropoff,
                miles: String(milesNum),
                email,
                whenDate,
                whenTime
              })
            });

            const avail = await safeJson(availResp);

            if (!avail.ok || !avail.json) {
              setBusy(false, 'Book & Pay');
              showErr('Unexpected response from scheduling system. Please try again.');
              return;
            }

            if (avail.json.available !== true) {
              setBusy(false, 'Book & Pay');
              alert(avail.json.message || 'That time slot is no longer available. Please choose a different time.');
              return;
            }

            setBusy(true, 'Creating checkout session…');

            const checkoutResp = await fetch('/api/stripe/create-checkout-session-v2', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                pickup,
                dropoff,
                miles: String(milesNum),
                email,
                whenDate,
                whenTime,
                notes
              })
            });

            const checkout = await safeJson(checkoutResp);

            if (!checkout.ok || !checkout.json || !checkout.json.url) {
              setBusy(false, 'Book & Pay');
              showErr('Unable to create checkout session. Please try again.');
              return;
            }

            window.location.href = checkout.json.url;

          } catch (err) {
            console.error(err);
            setBusy(false, 'Book & Pay');
            showErr('Unexpected error. Please try again.');
          }
        });
      })();
    </script>
  </body>
</html>
