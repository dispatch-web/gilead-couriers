<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gilead Couriers — Book a Job</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #f6f7fb; color:#111; }
      .wrap { max-width: 760px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
      h1 { margin: 0 0 8px; font-size: 24px; }
      p.sub { margin: 0 0 20px; color:#444; }
      label { display:block; font-weight:600; margin: 14px 0 6px; }
      input, textarea, select { width:100%; box-sizing:border-box; padding: 10px 12px; border: 1px solid #d7dbe7; border-radius: 10px; font-size: 14px; }
      textarea { min-height: 76px; resize: vertical; }
      .row { display:flex; gap: 12px; }
      .row > div { flex:1; }
      .hint { font-size: 12px; color:#666; margin-top: 6px; }
      .btn { margin-top: 18px; width:100%; padding: 12px 14px; border:0; border-radius: 12px; font-weight:700; cursor:pointer; background:#111; color:#fff; font-size: 15px; }
      .btn[disabled]{ opacity:.6; cursor:not-allowed; }
      .msg { margin-top: 14px; padding: 12px; border-radius: 10px; display:none; }
      .msg.ok { background:#e9f8ef; color:#0f5132; border:1px solid #b7ebc6; }
      .msg.err { background:#fdecec; color:#842029; border:1px solid #f5c2c7; }
      .small { font-size: 12px; color:#666; margin-top: 10px; }
      .footer { margin-top: 14px; font-size: 12px; color:#666; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Book a courier job</h1>
      <p class="sub">Fixed fee within 20 miles. Long-distance is priced by mileage + rules. Secure payment via Stripe.</p>

      <form id="bookingForm">
        <label for="pickup">Pickup address *</label>
        <textarea id="pickup" name="pickup" required placeholder="e.g. 10 Downing Street, London SW1A 2AA"></textarea>

        <label for="dropoff">Drop-off address *</label>
        <textarea id="dropoff" name="dropoff" required placeholder="e.g. 1 St Peter’s Square, Manchester M2 3AE"></textarea>

        <div class="row">
          <div>
            <label for="miles">Estimated miles *</label>
            <input id="miles" name="miles" type="number" min="1" step="1" required placeholder="e.g. 234" />
            <div class="hint">Enter an approximate mileage for now (routing automation comes later).</div>
          </div>
          <div>
            <label for="email">Your email address *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="whenDate">When is this job needed? (date) *</label>
            <input id="whenDate" name="whenDate" type="date" required />
          </div>
          <div>
            <label for="whenTime">Time needed by *</label>
            <input id="whenTime" name="whenTime" type="time" required />
          </div>
        </div>

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" name="notes" placeholder="Fragile items, access instructions, parking, contact name, etc."></textarea>

        <button class="btn" id="payBtn" type="submit">Book &amp; Pay</button>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>

        <div class="footer">
          By proceeding you agree to our terms and policies.
        </div>
      </form>
    </div>

    <script>
      (function () {
        const form = document.getElementById('bookingForm');
        const payBtn = document.getElementById('payBtn');
        const msgOk = document.getElementById('msgOk');
        const msgErr = document.getElementById('msgErr');

        function showOk(text) {
          msgOk.textContent = text;
          msgOk.style.display = 'block';
          msgErr.style.display = 'none';
        }

        function showErr(text) {
          msgErr.textContent = text;
          msgErr.style.display = 'block';
          msgOk.style.display = 'none';
        }

        function setBusy(isBusy) {
          payBtn.disabled = isBusy;
          payBtn.textContent = isBusy ? 'Checking availability…' : 'Book & Pay';
        }

        function getValue(id) {
          const el = document.getElementById(id);
          return (el && typeof el.value === 'string') ? el.value.trim() : '';
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          // Clear messages
          msgOk.style.display = 'none';
          msgErr.style.display = 'none';

          const pickup = getValue('pickup');
          const dropoff = getValue('dropoff');
          const miles = getValue('miles');
          const email = getValue('email');
          const whenDate = getValue('whenDate');
          const whenTime = getValue('whenTime');
          const notes = getValue('notes');

          // Basic front-end validation
          if (!pickup || !dropoff || !miles || !email || !whenDate || !whenTime) {
            showErr('Please complete all required fields.');
            return;
          }

          const milesNum = Number(miles);
          if (!Number.isFinite(milesNum) || milesNum <= 0) {
            showErr('Please enter a valid mileage value.');
            return;
          }

          setBusy(true);

          try {
            // 1) Check availability (server-side calls Make; avoids CSP issues)
            const availabilityResp = await fetch('/api/availability', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                pickup,
                dropoff,
                miles: String(milesNum),
                email,
                whenDate,
                whenTime
              })
            });

            const availabilityText = await availabilityResp.text();
            let availability;
            try {
              availability = JSON.parse(availabilityText);
            } catch (err) {
              setBusy(false);
              showErr('We could not check availability. Please try again.');
              return;
            }

            if (!availabilityResp.ok) {
              setBusy(false);
              showErr(availability.message || 'We could not check availability. Please try again.');
              return;
            }

            if (!availability.available) {
              setBusy(false);

              // NEW: show suggested time if provided by Make
              let msg = availability.message || 'That time slot is no longer available. Please choose a different time.';
              if (availability.suggestedTime) {
                msg += '\n\nSuggested alternative:\n' + availability.suggestedTime;
              }

              // Keep using alert for simplicity/consistency with your current build
              alert(msg);
              return;
            }

            // 2) Create Stripe checkout session (v2 route)
            payBtn.textContent = 'Creating checkout session…';

            const checkoutResp = await fetch('/api/stripe/create-checkout-session-v2', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                pickup,
                dropoff,
                miles: String(milesNum),
                email,
                whenDate,
                whenTime,
                notes
              })
            });

            const checkoutText = await checkoutResp.text();
            let checkout;
            try {
              checkout = JSON.parse(checkoutText);
            } catch (err) {
              setBusy(false);
              showErr('Unable to create checkout session. Please try again.');
              return;
            }

            if (!checkoutResp.ok) {
              setBusy(false);
              showErr(checkout.error || 'Unable to create checkout session. Please try again.');
              return;
            }

            if (!checkout.url) {
              setBusy(false);
              showErr('Checkout session created but no URL was returned. Please try again.');
              return;
            }

            // Redirect to Stripe Checkout
            window.location.href = checkout.url;
          } catch (err) {
            console.error(err);
            setBusy(false);
            showErr('Unexpected error. Please try again.');
          }
        });
      })();
    </script>
  </body>
</html>
